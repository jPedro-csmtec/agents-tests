from typing import Any
from services.tests.general import request_base

url = "summary-info/summary"
data = {"text_summary": Any, "agent_resume": True}


def test_correct_results():
    data["text_summary"] = (
        "Informações do paciente\nJoana Ribeiro, 42 anos, comparece ao pronto-atendimento com queixa de febre alta e dores no corpo há dois dias.\n\nHistórico da moléstia atual\nPaciente relata início súbito de febre alta, calafrios, cefaleia intensa, dores musculares generalizadas, coriza e tosse seca há cerca de dois dias. Refere também prostração importante e dor de garganta, sem presença de vômitos ou diarreia. Informa que o quadro começou após contato próximo com o neto, que apresentou sintomas semelhantes na semana anterior. Nega dispneia, dor torácica ou outros sintomas respiratórios mais graves até o momento.\n\nHistória patológica pregressa\nA paciente é portadora de hipertensão arterial sistêmica, em uso regular de losartana, com controle adequado. Nega outras doenças crônicas, internações prévias ou cirurgias. Refere não possuir alergias conhecidas a medicamentos ou alimentos e nunca fez uso de imunossupressores.\n\nHistórico familiar\nRelata que a mãe é hipertensa e diabética, ambas condições controladas com medicação. O pai faleceu aos 70 anos devido a um acidente vascular cerebral isquêmico. Nega histórico familiar de doenças genéticas, autoimunes ou respiratórias crônicas. Não há casos conhecidos de neoplasias de aparecimento precoce na família.\n\nHistórico social\nTrabalha como professora da educação infantil em escola pública, tendo contato frequente com crianças. Nega tabagismo e faz uso ocasional de bebidas alcoólicas em eventos sociais. Refere sono regular de aproximadamente sete horas por noite, mas não pratica atividade física com regularidade. Alimenta-se de forma variada, embora reconheça consumo esporádico de alimentos ultraprocessados durante a semana.\n\nExame físico\nApresenta-se em bom estado geral, embora com fácies febril e discreta prostração. Está febril (38,7 °C), com frequência cardíaca de 104 bpm, pressão arterial de 130/80 mmHg e saturação periférica de oxigênio de 97% em ar ambiente. Mucosas orais e nasais estão hiperemiadas, com orofaringe levemente avermelhada, sem exsudato. Ausculta pulmonar revela murmúrio vesicular presente e simétrico, sem ruídos adventícios. Abdome flácido, indolor à palpação, sem visceromegalias. Demais sistemas sem alterações significativas.\n\nExames complementares\nHemograma: leucocitose leve com predomínio de neutrófilos\nPCR: 12 mg/L\nTeste rápido para Influenza A: positivo\nRaio-X de tórax: campos pulmonares limpos, sem infiltrado evidente\n\n## Código CID\n### Sumário de códigos encontrados\n1. **J10.1 – Influenza [gripe] devida a vírus influenza identificado, com outras manifestações respiratórias**\n2. **I10 – Hipertensão essencial (primária)**\n3. **R50.9 – Febre, não especificada**\n4. **R51 – Cefaleia**\n5. **M79.1 – Mialgia**\n6. **R05 – Tosse**\n7. **R07.0 – Dor de garganta**\n8. **R53 – Mal-estar e fadiga**\n9. **D72.8 – Outros transtornos especificados dos leucócitos (leucocitose)**\n10. **R79.8 – Outros achados anormais especificados de exames químicos do sangue (PCR elevada)**\n> Observação: em prática de codificação, geralmente o diagnóstico principal (influenza) e comorbidades relevantes (hipertensão) são prioritários; os sintomas costumam ser codificados apenas se houver necessidade específica. Aqui, todos os códigos possíveis a partir dos dados fornecidos estão listados.\n---\n### Detalhes por código\n#### 1. Código CID\n**J10.1**\n- **Descrição:** Influenza [gripe] devida a vírus influenza identificado, com outras manifestações respiratórias\n- **Categoria Principal:** Capítulo X – Doenças do aparelho respiratório (J00–J99)\n- **Nome:** Influenza por vírus identificado, com outras manifestações respiratórias\n- **Definição:** Influenza aguda causada por vírus influenza comprovado por exame laboratorial ou outro método de identificação, caracterizada por início súbito de febre, sintomas respiratórios altos (coriza, tosse, dor de garganta) e sintomas sistêmicos (mialgia, cefaleia, mal-estar), **sem pneumonia**.\n- **Descrição Detalhada (critérios, cenários de uso, observações):**\n- Usar J10.* quando há identificação do vírus influenza (por exemplo, teste rápido positivo, PCR, cultura).\n- Subcategoria **J10.1** específica para casos em que:\n    - há manifestações respiratórias (tosse, coriza, dor de garganta, irritação de vias aéreas superiores);\n    - não há evidência de pneumonia clínica ou radiológica.\n- Excluir J10.0 (com pneumonia) quando o RX de tórax é normal e não há sinais clínicos de pneumonia.\n- Pode coexistir com sintomas sistêmicos intensos (mialgia, cefaleia, prostração), sem necessidade de subcategoria adicional, pois estes estão incluídos na síndrome gripal.\n- **Justificativa de associação:**\n- Teste rápido para **Influenza A: positivo** → vírus influenza identificado.\n- Quadro agudo de 2 dias com:\n    - febre alta, calafrios;\n    - tosse seca, coriza, dor de garganta;\n    - cefaleia intensa, dores musculares generalizadas, prostração;\n- Ausência de infiltrado pulmonar em RX de tórax e ausculta pulmonar sem ruídos adventícios → **sem pneumonia**, logo J10.0 é excluído.\n→ Portanto, o código mais adequado é **J10.1** (influenza por vírus identificado com outras manifestações respiratórias).\n---\n#### 2. Código CID\n**I10**\n- **Descrição:** Hipertensão essencial (primária)\n- **Categoria Principal:** Capítulo IX – Doenças do aparelho circulatório (I00–I99)\n- **Nome:** Hipertensão arterial essencial (primária)\n- **Definição:** Elevação crônica da pressão arterial sem causa secundária identificável (não atribuída a doença renal, endócrina, etc.), frequentemente tratada de forma contínua com anti-hipertensivos.\n- **Descrição Detalhada (critérios, cenários de uso, observações):**\n- Utilizado para pacientes com diagnóstico estabelecido de hipertensão arterial sistêmica, controlada ou não, sem etiologia secundária descrita no prontuário.\n- Abrange a hipertensão tratada com monoterapia ou combinação de fármacos.\n- Importante como comorbidade em qualquer atendimento agudo, pois pode influenciar conduta e risco cardiovascular.\n- **Justificativa de associação:**\n- História patológica pregressa: “**portadora de hipertensão arterial sistêmica, em uso regular de losartana, com controle adequado**.”\n- Não há menção de causa secundária (doença renal, endócrina etc.).\n→ Configura **hipertensão essencial**, código **I10**.\n---\n#### 3. Código CID\n**R50.9**\n- **Descrição:** Febre, não especificada\n- **Categoria Principal:** Capítulo XVIII – Sintomas, sinais e achados anormais de exames clínicos e de laboratório, não classificados em outra parte (R00–R99)\n- **Nome:** Febre, não especificada\n- **Definição:** Elevação da temperatura corporal acima dos valores considerados normais, sem especificação da causa no próprio código.\n- **Descrição Detalhada (critérios, cenários de uso, observações):**\n- Usado quando se deseja registrar o sintoma febre como dado clínico relevante.\n- Em presença de diagnóstico etiológico (influenza), muitas vezes o sintoma não é codificado separadamente, mas é perfeitamente aceitável listá-lo se o foco for documentar o quadro clínico completo.\n- **Justificativa de associação:**\n- Queixa principal de “**febre alta**” há dois dias.\n- Exame físico: temperatura de **38,7 °C**.\n→ Sintoma febre presente e documentado, compatível com **R50.9**.\n---\n#### 4. Código CID\n**R51**\n- **Descrição:** Cefaleia\n- **Categoria Principal:** Capítulo XVIII – Sintomas, sinais e achados anormais de exames clínicos e de laboratório (R00–R99)\n- **Nome:** Cefaleia\n- **Definição:** Dor localizada na região da cabeça, sem especificação de tipo (tensional, enxaqueca, etc.) quando codificada em R51.\n- **Descrição Detalhada (critérios, cenários de uso, observações):**\n- Utilizado para dor de cabeça como sintoma em diversos contextos.\n- Em quadros infecciosos agudos, a cefaleia é frequentemente secundária à doença de base (aqui, influenza), mas pode ser registrada.\n- **Justificativa de associação:**\n- HMA: “**cefaleia intensa**” associada ao quadro febril.\n- Não há descrição de enxaqueca ou outro tipo específico → cefaleia inespecífica.\n→ Código sintomático adequado: **R51**.\n---\n#### 5. Código CID\n**M79.1**\n- **Descrição:** Mialgia\n- **Categoria Principal:** Capítulo XIII – Doenças do sistema osteomuscular e do tecido conjuntivo (M00–M99)\n- **Nome:** Mialgia\n- **Definição:** Dor muscular localizada ou generalizada, de origem não especificada, podendo estar associada a infecções virais, esforço físico, doenças reumáticas etc.\n- **Descrição Detalhada (critérios, cenários de uso, observações):**\n- Usado para dor muscular sem diagnóstico etiológico distinto no próprio código.\n- Em síndromes gripais, mialgia difusa é um achado típico e pode ser registrada como tal.\n- **Justificativa de associação:**\n- HMA: “**dores musculares generalizadas**”.\n- Não há descrição de trauma, doenças musculares específicas ou outra etiologia.\n→ Sintoma de mialgia codificável como **M79.1**.\n---\n#### 6. Código CID\n**R05**\n- **Descrição:** Tosse\n- **Categoria Principal:** Capítulo XVIII – Sintomas, sinais e achados anormais de exames clínicos e de laboratório (R00–R99)\n- **Nome:** Tosse\n- **Definição:** Expulsão súbita e ruidosa de ar dos pulmões, voluntária ou reflexa, acompanhando diversas doenças respiratórias.\n- **Descrição Detalhada (critérios, cenários de uso, observações):**\n- Sintoma respiratório muito comum, usado quando se quer explicitar a presença de tosse.\n- Em casos de influenza, a tosse faz parte do quadro síndrome gripal, mas ainda assim pode ser codificada como sintoma.\n- **Justificativa de associação:**\n- HMA: “**tosse seca**” há cerca de dois dias.\n- Não há especificação adicional (expectorante, hemoptise etc.), logo código genérico de tosse é adequado.\n→ **R05** devidamente aplicável.\n---\n#### 7. Código CID\n**R07.0**\n- **Descrição:** Dor de garganta\n- **Categoria Principal:** Capítulo XVIII – Sintomas, sinais e achados anormais de exames clínicos e de laboratório (R00–R99)\n- **Nome:** Dor de garganta\n- **Definição:** Dor localizada na região da orofaringe/hipofaringe, seja por processo infeccioso, inflamatório, irritativo ou outro, sem especificação etiológica.\n- **Descrição Detalhada (critérios, cenários de uso, observações):**\n- Usado quando a dor de garganta é descrita como sintoma, sem diagnóstico específico de faringite ou amigdalite (J02, J03 etc.).\n- Quando se opta por manter o diagnóstico global de influenza (sem faringite específica), a dor de garganta pode ser codificada como sintoma.\n- **Justificativa de associação:**\n- HMA: “**dor de garganta**”.\n- Exame físico: “**orofaringe levemente avermelhada, sem exsudato**”, mas o diagnóstico principal adotado foi influenza, não faringite isolada.\n→ Sintoma compatível com **R07.0**.\n---\n#### 8. Código CID\n**R53**\n- **Descrição:** Mal-estar e fadiga\n- **Categoria Principal:** Capítulo XVIII – Sintomas, sinais e achados anormais de exames clínicos e de laboratório (R00–R99)\n- **Nome:** Mal-estar e fadiga\n- **Definição:** Sensação de fraqueza, cansaço, prostração ou indisposição geral, não atribuída a uma condição específica no próprio código.\n- **Descrição Detalhada (critérios, cenários de uso, observações):**\n- Comum em quadros infecciosos agudos como influenza.\n- Pode ser usado para documentar a intensidade do comprometimento geral do paciente.\n- **Justificativa de associação:**\n- HMA: “**prostração importante**”.\n- Exame físico: discreta prostração, apesar de bom estado geral.\n→ Sintoma de mal-estar/prostração enquadra-se em **R53**.\n---\n#### 9. Código CID\n**D72.8**\n- **Descrição:** Outros transtornos especificados dos leucócitos\n- **Categoria Principal:** Capítulo III – Doenças do sangue e dos órgãos hematopoéticos e alguns transtornos imunitários (D50–D89)\n- **Nome:** Outros transtornos especificados dos leucócitos\n- **Definição:** Alterações quantitativas ou qualitativas dos leucócitos não classificadas em categorias mais específicas, incluindo leucocitose.\n- **Descrição Detalhada (critérios, cenários de uso, observações):**\n- Abrange **leucocitose** não atribuída a doenças hematológicas específicas.\n- Frequentemente secundária a processos infecciosos agudos, inflamações etc.\n- Em muitas situações, este código não é usado isoladamente quando a leucocitose é claramente reacional à infecção de base; contudo, é um código válido para registrar o achado laboratorial.\n- **Justificativa de associação:**\n- Hemograma: “**leucocitose leve com predomínio de neutrófilos**.”\n- Não há evidência de doença hematológica primária, sendo compatível com leucocitose reacional ao quadro infeccioso.\n→ Achado laboratorial compatível com **D72.8**.\n---\n#### 10. Código CID\n**R79.8**\n- **Descrição:** Outros achados anormais especificados de exames químicos do sangue\n- **Categoria Principal:** Capítulo XVIII – Sintomas, sinais e achados anormais de exames clínicos e de laboratório (R00–R99)\n- **Nome:** Outros achados anormais especificados de exames químicos do sangue\n- **Definição:** Alterações em parâmetros de exames bioquímicos sanguíneos que não possuem código específico em outras categorias.\n- **Descrição Detalhada (critérios, cenários de uso, observações):**\n- Inclui resultados alterados de marcadores inflamatórios (como proteína C reativa) quando não codificados de outra forma.\n- Em geral é código secundário, usado quando se deseja registrar explicitamente o achado laboratorial.\n- **Justificativa de associação:**\n- Exames complementares: **PCR: 12 mg/L**, valor descrito como elevado para o contexto.\n- Não há outro código mais específico para PCR elevada.\n→ Achado enquadrável em **R79.8**.\n---\nMinistério da Saúde - CID-10 Brasil, 10ª Revisão, 2020.\n\n### Dados coletados\n\n- **Identificação e medidas**:\n- Idade: 42 anos\n- Sexo: Feminino\n- Peso: não informado\n- Altura: não informado\n- IMC: não informado\n\n- **Sintomas principais**:\n- Febre alta (38,7 °C)\n- Calafrios\n- Cefaleia intensa\n- Dores musculares generalizadas\n- Coriza\n- Tosse seca\n- Prostração importante\n- Dor de garganta\n\n- **Histórico relevante**:\n- **História patológica pregressa**: Hipertensão arterial sistêmica controlada com losartana. Nega outras doenças crônicas, internações ou cirurgias. Sem alergias conhecidas.\n- **Histórico familiar**: Mãe hipertensa e diabética, pai falecido por acidente vascular cerebral. Sem histórico de doenças genéticas ou neoplasias precoces.\n- **Histórico social**: Professora da educação infantil, sem tabagismo, uso ocasional de álcool. Sono regular, sem atividade física regular.\n\n- **Exames disponíveis**:\n- Hemograma: leucocitose leve com predomínio de neutrófilos\n- PCR: 12 mg/L\n- Teste rápido para Influenza A: positivo\n- Raio-X de tórax: campos pulmonares limpos, sem infiltrado evidente\n\n### Avaliação diagnóstica (sumária)\n\n- **Condição(ões) mais prováveis**: Influenza (J10.1) confirmada pelo teste rápido positivo, com sintomas compatíveis.\n- **Principais diferenciais**: Outras infecções virais (como COVID-19), infecções bacterianas respiratórias, e outras síndromes gripais.\n- **Critérios oficiais atendidos**: Diagnóstico de influenza confirmado por teste laboratorial, com quadro clínico compatível.\n- **Achados críticos/inesperados**: Nenhum achado crítico além da confirmação da influenza.\n- **Justificativa sumária**: A paciente apresenta um quadro clínico clássico de influenza, com febre alta, sintomas respiratórios e mialgia, além de um teste rápido positivo. A ausência de sinais de pneumonia e a leucocitose leve são consistentes com uma infecção viral.\n\n### Plano de investigação adicional\n\n- **Exames sugeridos**:\n1. **Teste PCR para COVID-19**: Para descartar coinfecção, dada a similaridade dos sintomas.\n2. **Hemoculturas**: Para investigar possíveis infecções bacterianas, especialmente se a febre persistir.\n3. **Exames de função hepática e renal**: Para monitorar a saúde geral, especialmente em pacientes com doenças crônicas.\n\n### Referências (se disponíveis)\n\n- Diretrizes da ADA (American Diabetes Association)\n- Diretrizes do Ministério da Saúde sobre manejo de infecções respiratórias\n- Diretrizes da OMS sobre influenza\n\n### Resumo final\n- **Principais achados**: Febre alta, cefaleia, dores musculares, tosse seca, e teste rápido positivo para Influenza A.\n- **Diagnóstico provável**: Influenza (J10.1).\n- **Diferenciais**: Outras infecções virais e bacterianas.\n- **Critérios atendidos**: Diagnóstico confirmado por teste laboratorial.\n- **Próximos passos recomendados**: Realizar testes adicionais para COVID-19, hemoculturas e monitorar a função hepática e renal.\n\n**Objetivo**\n\nAvaliar o quadro clínico de Joana Ribeiro, 42 anos, que apresenta sintomas sugestivos de uma infecção respiratória aguda, com foco na confirmação de influenza e manejo adequado.\n\n**Metodologia**\n\n- Avaliação clínica completa, incluindo histórico médico e exame físico.\n- Exames laboratoriais: hemograma, PCR, teste rápido para Influenza A.\n- Exame de imagem: raio-X de tórax.\n\n**Resultados**\n\n- Teste rápido para Influenza A: positivo.\n- Hemograma: leucocitose leve com predomínio de neutrófilos.\n- PCR: 12 mg/L.\n- Raio-X de tórax: campos pulmonares limpos, sem infiltrado evidente.\n- Exame físico: febre de 38,7°C, fácies febril, orofaringe levemente avermelhada.\n\n**Conclusões**\n\nO diagnóstico provável é de influenza (CID-10: J10.1), confirmado pelo teste rápido. A paciente apresenta sintomas clássicos da doença, como febre alta, cefaleia, mialgia e sintomas respiratórios, sem sinais de pneumonia. A leucocitose leve é compatível com uma resposta inflamatória viral. Considerando o contexto clínico e epidemiológico, a influenza é a condição mais provável.\n\n**Planejamento**\n\n- **Cuidados Necessários**: Monitorar sinais de complicações, como dificuldade respiratória ou piora do estado geral.\n- **Exames de Acompanhamento**:\n  - Teste PCR para COVID-19: para descartar coinfecção, dados os sintomas semelhantes.\n  - Hemoculturas: se a febre persistir ou houver suspeita de infecção bacteriana secundária.\n- **Encaminhamentos e Tratamento**:\n  - Manter hidratação adequada e repouso.\n  - Considerar antiviral específico para influenza, se indicado.\n  - Acompanhamento com clínico geral para monitorar evolução.\n\n**Referências**\n\n- Diretrizes do Ministério da Saúde sobre manejo de infecções respiratórias.\n- Diretrizes da OMS sobre influenza.\n- Fontes não informadas.\n\n**Resumo Final**\n\nJoana Ribeiro apresenta um quadro clínico típico de influenza, confirmado por teste laboratorial. O manejo inclui monitoramento de complicações e testes adicionais para descartar outras infecções. O tratamento sintomático e o repouso são essenciais para a recuperação.\n\n**Objetivo**\n\nAvaliar o quadro clínico de Joana Ribeiro, 42 anos, que apresenta sintomas sugestivos de infecção respiratória aguda, com foco na confirmação diagnóstica e proposição de tratamento adequado.\n\n**Metodologia**\n\nAnálise dos sintomas relatados, histórico médico, exame físico e resultados laboratoriais, incluindo teste rápido para Influenza A, hemograma e PCR.\n\n**Resultados e conclusões**\n\n- **Diagnóstico principal**: Influenza A confirmado por teste rápido, com sintomas clássicos de febre alta, cefaleia, mialgia, coriza, tosse seca e dor de garganta.\n- **Exames laboratoriais**: Leucocitose leve com predomínio de neutrófilos e PCR elevado (12 mg/L), sem sinais de pneumonia no raio-X de tórax.\n- **Histórico relevante**: Hipertensão arterial sistêmica controlada com losartana, sem outras comorbidades significativas.\n\n**Tratamento e recomendações**\n\n- **Medicamentos**: Considerar o uso de antivirais, como inibidores da neuraminidase, conforme diretrizes para casos de influenza confirmada.\n- **Medidas não farmacológicas**: Recomendação de repouso, hidratação adequada e uso de antitérmicos para controle da febre.\n- **Exames adicionais**:\n  - **Teste PCR para COVID-19**: Para descartar coinfecção, dados os sintomas semelhantes.\n  - **Hemoculturas**: Se a febre persistir, para excluir infecções bacterianas secundárias.\n  - **Função hepática e renal**: Monitorar devido ao uso de medicamentos e histórico de hipertensão.\n\n**Referências**\n\n- Diretrizes do Ministério da Saúde sobre manejo de infecções respiratórias.\n- Diretrizes da OMS sobre influenza.\n\n**Resumo final**\n\nJoana Ribeiro apresenta um quadro clínico compatível com influenza A, confirmado por teste rápido. O tratamento deve incluir antivirais e suporte sintomático, com monitoramento contínuo para descartar outras infecções e complicações. Testes adicionais são recomendados para garantir um manejo abrangente e seguro."
    )

    response = request_base(url, data)
    result_data: str = response.json()["data"]["result"]

    assert response.status_code == 200
    assert "febre alta" in result_data
    assert "dores no corpo" in result_data
    assert "J10.1" in result_data
    assert "influenza a" in result_data.lower()
    assert "teste pcr para covid-19" in result_data.lower()
    assert "repouso" in result_data.lower()
    assert "hidratação" in result_data.lower()


def test_error_invalid_input():
    data["text_summary"] = 500

    response = request_base(url, data)
    result_data = response.json()["detail"][0]

    assert response.status_code == 422
    assert "Input should be a valid string" in result_data["msg"]
