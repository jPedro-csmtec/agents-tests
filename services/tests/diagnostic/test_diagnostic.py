from typing import Any
from services.tests.general import request_base

url = "diagnostic-info/diagnostics"
data = {"text_diagnostic": Any, "model": "gpt-4o-mini"}


def test_correct_results():
    data["text_diagnostic"] = (
        "Informações do paciente\nJoana Ribeiro, 42 anos, comparece ao pronto-atendimento com queixa de febre alta e dores no corpo há dois dias.\n\nHistórico da moléstia atual\nPaciente relata início súbito de febre alta, calafrios, cefaleia intensa, dores musculares generalizadas, coriza e tosse seca há cerca de dois dias. Refere também prostração importante e dor de garganta, sem presença de vômitos ou diarreia. Informa que o quadro começou após contato próximo com o neto, que apresentou sintomas semelhantes na semana anterior. Nega dispneia, dor torácica ou outros sintomas respiratórios mais graves até o momento.\n\nHistória patológica pregressa\nA paciente é portadora de hipertensão arterial sistêmica, em uso regular de losartana, com controle adequado. Nega outras doenças crônicas, internações prévias ou cirurgias. Refere não possuir alergias conhecidas a medicamentos ou alimentos e nunca fez uso de imunossupressores.\n\nHistórico familiar\nRelata que a mãe é hipertensa e diabética, ambas condições controladas com medicação. O pai faleceu aos 70 anos devido a um acidente vascular cerebral isquêmico. Nega histórico familiar de doenças genéticas, autoimunes ou respiratórias crônicas. Não há casos conhecidos de neoplasias de aparecimento precoce na família.\n\nHistórico social\nTrabalha como professora da educação infantil em escola pública, tendo contato frequente com crianças. Nega tabagismo e faz uso ocasional de bebidas alcoólicas em eventos sociais. Refere sono regular de aproximadamente sete horas por noite, mas não pratica atividade física com regularidade. Alimenta-se de forma variada, embora reconheça consumo esporádico de alimentos ultraprocessados durante a semana.\n\nExame físico\nApresenta-se em bom estado geral, embora com fácies febril e discreta prostração. Está febril (38,7 °C), com frequência cardíaca de 104 bpm, pressão arterial de 130/80 mmHg e saturação periférica de oxigênio de 97% em ar ambiente. Mucosas orais e nasais estão hiperemiadas, com orofaringe levemente avermelhada, sem exsudato. Ausculta pulmonar revela murmúrio vesicular presente e simétrico, sem ruídos adventícios. Abdome flácido, indolor à palpação, sem visceromegalias. Demais sistemas sem alterações significativas.\n\nExames complementares\nHemograma: leucocitose leve com predomínio de neutrófilos\nPCR: 12 mg/L\nTeste rápido para Influenza A: positivo\nRaio-X de tórax: campos pulmonares limpos, sem infiltrado evidente\n\n## Código CID\n### Sumário de códigos encontrados\n1. **J10.1 – Influenza [gripe] devida a vírus influenza identificado, com outras manifestações respiratórias**\n2. **I10 – Hipertensão essencial (primária)**\n3. **R50.9 – Febre, não especificada**\n4. **R51 – Cefaleia**\n5. **M79.1 – Mialgia**\n6. **R05 – Tosse**\n7. **R07.0 – Dor de garganta**\n8. **R53 – Mal-estar e fadiga**\n9. **D72.8 – Outros transtornos especificados dos leucócitos (leucocitose)**\n10. **R79.8 – Outros achados anormais especificados de exames químicos do sangue (PCR elevada)**\n> Observação: em prática de codificação, geralmente o diagnóstico principal (influenza) e comorbidades relevantes (hipertensão) são prioritários; os sintomas costumam ser codificados apenas se houver necessidade específica. Aqui, todos os códigos possíveis a partir dos dados fornecidos estão listados.\n---\n### Detalhes por código\n#### 1. Código CID\n**J10.1**\n- **Descrição:** Influenza [gripe] devida a vírus influenza identificado, com outras manifestações respiratórias\n- **Categoria Principal:** Capítulo X – Doenças do aparelho respiratório (J00–J99)\n- **Nome:** Influenza por vírus identificado, com outras manifestações respiratórias\n- **Definição:** Influenza aguda causada por vírus influenza comprovado por exame laboratorial ou outro método de identificação, caracterizada por início súbito de febre, sintomas respiratórios altos (coriza, tosse, dor de garganta) e sintomas sistêmicos (mialgia, cefaleia, mal-estar), **sem pneumonia**.\n- **Descrição Detalhada (critérios, cenários de uso, observações):**\n- Usar J10.* quando há identificação do vírus influenza (por exemplo, teste rápido positivo, PCR, cultura).\n- Subcategoria **J10.1** específica para casos em que:\n    - há manifestações respiratórias (tosse, coriza, dor de garganta, irritação de vias aéreas superiores);\n    - não há evidência de pneumonia clínica ou radiológica.\n- Excluir J10.0 (com pneumonia) quando o RX de tórax é normal e não há sinais clínicos de pneumonia.\n- Pode coexistir com sintomas sistêmicos intensos (mialgia, cefaleia, prostração), sem necessidade de subcategoria adicional, pois estes estão incluídos na síndrome gripal.\n- **Justificativa de associação:**\n- Teste rápido para **Influenza A: positivo** → vírus influenza identificado.\n- Quadro agudo de 2 dias com:\n    - febre alta, calafrios;\n    - tosse seca, coriza, dor de garganta;\n    - cefaleia intensa, dores musculares generalizadas, prostração;\n- Ausência de infiltrado pulmonar em RX de tórax e ausculta pulmonar sem ruídos adventícios → **sem pneumonia**, logo J10.0 é excluído.\n→ Portanto, o código mais adequado é **J10.1** (influenza por vírus identificado com outras manifestações respiratórias).\n---\n#### 2. Código CID\n**I10**\n- **Descrição:** Hipertensão essencial (primária)\n- **Categoria Principal:** Capítulo IX – Doenças do aparelho circulatório (I00–I99)\n- **Nome:** Hipertensão arterial essencial (primária)\n- **Definição:** Elevação crônica da pressão arterial sem causa secundária identificável (não atribuída a doença renal, endócrina, etc.), frequentemente tratada de forma contínua com anti-hipertensivos.\n- **Descrição Detalhada (critérios, cenários de uso, observações):**\n- Utilizado para pacientes com diagnóstico estabelecido de hipertensão arterial sistêmica, controlada ou não, sem etiologia secundária descrita no prontuário.\n- Abrange a hipertensão tratada com monoterapia ou combinação de fármacos.\n- Importante como comorbidade em qualquer atendimento agudo, pois pode influenciar conduta e risco cardiovascular.\n- **Justificativa de associação:**\n- História patológica pregressa: “**portadora de hipertensão arterial sistêmica, em uso regular de losartana, com controle adequado**.”\n- Não há menção de causa secundária (doença renal, endócrina etc.).\n→ Configura **hipertensão essencial**, código **I10**.\n---\n#### 3. Código CID\n**R50.9**\n- **Descrição:** Febre, não especificada\n- **Categoria Principal:** Capítulo XVIII – Sintomas, sinais e achados anormais de exames clínicos e de laboratório, não classificados em outra parte (R00–R99)\n- **Nome:** Febre, não especificada\n- **Definição:** Elevação da temperatura corporal acima dos valores considerados normais, sem especificação da causa no próprio código.\n- **Descrição Detalhada (critérios, cenários de uso, observações):**\n- Usado quando se deseja registrar o sintoma febre como dado clínico relevante.\n- Em presença de diagnóstico etiológico (influenza), muitas vezes o sintoma não é codificado separadamente, mas é perfeitamente aceitável listá-lo se o foco for documentar o quadro clínico completo.\n- **Justificativa de associação:**\n- Queixa principal de “**febre alta**” há dois dias.\n- Exame físico: temperatura de **38,7 °C**.\n→ Sintoma febre presente e documentado, compatível com **R50.9**.\n---\n#### 4. Código CID\n**R51**\n- **Descrição:** Cefaleia\n- **Categoria Principal:** Capítulo XVIII – Sintomas, sinais e achados anormais de exames clínicos e de laboratório (R00–R99)\n- **Nome:** Cefaleia\n- **Definição:** Dor localizada na região da cabeça, sem especificação de tipo (tensional, enxaqueca, etc.) quando codificada em R51.\n- **Descrição Detalhada (critérios, cenários de uso, observações):**\n- Utilizado para dor de cabeça como sintoma em diversos contextos.\n- Em quadros infecciosos agudos, a cefaleia é frequentemente secundária à doença de base (aqui, influenza), mas pode ser registrada.\n- **Justificativa de associação:**\n- HMA: “**cefaleia intensa**” associada ao quadro febril.\n- Não há descrição de enxaqueca ou outro tipo específico → cefaleia inespecífica.\n→ Código sintomático adequado: **R51**.\n---\n#### 5. Código CID\n**M79.1**\n- **Descrição:** Mialgia\n- **Categoria Principal:** Capítulo XIII – Doenças do sistema osteomuscular e do tecido conjuntivo (M00–M99)\n- **Nome:** Mialgia\n- **Definição:** Dor muscular localizada ou generalizada, de origem não especificada, podendo estar associada a infecções virais, esforço físico, doenças reumáticas etc.\n- **Descrição Detalhada (critérios, cenários de uso, observações):**\n- Usado para dor muscular sem diagnóstico etiológico distinto no próprio código.\n- Em síndromes gripais, mialgia difusa é um achado típico e pode ser registrada como tal.\n- **Justificativa de associação:**\n- HMA: “**dores musculares generalizadas**”.\n- Não há descrição de trauma, doenças musculares específicas ou outra etiologia.\n→ Sintoma de mialgia codificável como **M79.1**.\n---\n#### 6. Código CID\n**R05**\n- **Descrição:** Tosse\n- **Categoria Principal:** Capítulo XVIII – Sintomas, sinais e achados anormais de exames clínicos e de laboratório (R00–R99)\n- **Nome:** Tosse\n- **Definição:** Expulsão súbita e ruidosa de ar dos pulmões, voluntária ou reflexa, acompanhando diversas doenças respiratórias.\n- **Descrição Detalhada (critérios, cenários de uso, observações):**\n- Sintoma respiratório muito comum, usado quando se quer explicitar a presença de tosse.\n- Em casos de influenza, a tosse faz parte do quadro síndrome gripal, mas ainda assim pode ser codificada como sintoma.\n- **Justificativa de associação:**\n- HMA: “**tosse seca**” há cerca de dois dias.\n- Não há especificação adicional (expectorante, hemoptise etc.), logo código genérico de tosse é adequado.\n→ **R05** devidamente aplicável.\n---\n#### 7. Código CID\n**R07.0**\n- **Descrição:** Dor de garganta\n- **Categoria Principal:** Capítulo XVIII – Sintomas, sinais e achados anormais de exames clínicos e de laboratório (R00–R99)\n- **Nome:** Dor de garganta\n- **Definição:** Dor localizada na região da orofaringe/hipofaringe, seja por processo infeccioso, inflamatório, irritativo ou outro, sem especificação etiológica.\n- **Descrição Detalhada (critérios, cenários de uso, observações):**\n- Usado quando a dor de garganta é descrita como sintoma, sem diagnóstico específico de faringite ou amigdalite (J02, J03 etc.).\n- Quando se opta por manter o diagnóstico global de influenza (sem faringite específica), a dor de garganta pode ser codificada como sintoma.\n- **Justificativa de associação:**\n- HMA: “**dor de garganta**”.\n- Exame físico: “**orofaringe levemente avermelhada, sem exsudato**”, mas o diagnóstico principal adotado foi influenza, não faringite isolada.\n→ Sintoma compatível com **R07.0**.\n---\n#### 8. Código CID\n**R53**\n- **Descrição:** Mal-estar e fadiga\n- **Categoria Principal:** Capítulo XVIII – Sintomas, sinais e achados anormais de exames clínicos e de laboratório (R00–R99)\n- **Nome:** Mal-estar e fadiga\n- **Definição:** Sensação de fraqueza, cansaço, prostração ou indisposição geral, não atribuída a uma condição específica no próprio código.\n- **Descrição Detalhada (critérios, cenários de uso, observações):**\n- Comum em quadros infecciosos agudos como influenza.\n- Pode ser usado para documentar a intensidade do comprometimento geral do paciente.\n- **Justificativa de associação:**\n- HMA: “**prostração importante**”.\n- Exame físico: discreta prostração, apesar de bom estado geral.\n→ Sintoma de mal-estar/prostração enquadra-se em **R53**.\n---\n#### 9. Código CID\n**D72.8**\n- **Descrição:** Outros transtornos especificados dos leucócitos\n- **Categoria Principal:** Capítulo III – Doenças do sangue e dos órgãos hematopoéticos e alguns transtornos imunitários (D50–D89)\n- **Nome:** Outros transtornos especificados dos leucócitos\n- **Definição:** Alterações quantitativas ou qualitativas dos leucócitos não classificadas em categorias mais específicas, incluindo leucocitose.\n- **Descrição Detalhada (critérios, cenários de uso, observações):**\n- Abrange **leucocitose** não atribuída a doenças hematológicas específicas.\n- Frequentemente secundária a processos infecciosos agudos, inflamações etc.\n- Em muitas situações, este código não é usado isoladamente quando a leucocitose é claramente reacional à infecção de base; contudo, é um código válido para registrar o achado laboratorial.\n- **Justificativa de associação:**\n- Hemograma: “**leucocitose leve com predomínio de neutrófilos**.”\n- Não há evidência de doença hematológica primária, sendo compatível com leucocitose reacional ao quadro infeccioso.\n→ Achado laboratorial compatível com **D72.8**.\n---\n#### 10. Código CID\n**R79.8**\n- **Descrição:** Outros achados anormais especificados de exames químicos do sangue\n- **Categoria Principal:** Capítulo XVIII – Sintomas, sinais e achados anormais de exames clínicos e de laboratório (R00–R99)\n- **Nome:** Outros achados anormais especificados de exames químicos do sangue\n- **Definição:** Alterações em parâmetros de exames bioquímicos sanguíneos que não possuem código específico em outras categorias.\n- **Descrição Detalhada (critérios, cenários de uso, observações):**\n- Inclui resultados alterados de marcadores inflamatórios (como proteína C reativa) quando não codificados de outra forma.\n- Em geral é código secundário, usado quando se deseja registrar explicitamente o achado laboratorial.\n- **Justificativa de associação:**\n- Exames complementares: **PCR: 12 mg/L**, valor descrito como elevado para o contexto.\n- Não há outro código mais específico para PCR elevada.\n→ Achado enquadrável em **R79.8**.\n---\nMinistério da Saúde - CID-10 Brasil, 10ª Revisão, 2020."
    )

    response = request_base(url, data)
    return_data: str = response.json()["data"]["result"]

    assert response.status_code == 200
    assert "Influenza" in return_data
    assert "J10" in return_data
    assert "febre" in return_data
    assert "teste rápido" in return_data.lower()
    assert "positivo" in return_data.lower()


def test_error_invalid_input():
    data["text_diagnostic"] = 500

    response = request_base(url, data)
    print(response.json())
    result_data = response.json()["detail"][0]

    assert response.status_code == 422
    assert "Input should be a valid string" in result_data["msg"]
